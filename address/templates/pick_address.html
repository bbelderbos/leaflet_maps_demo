{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pick address</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <style>
  /* Container for form */
  #form-container {
    margin: 1rem 0;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fafafa;
  }

  /* Form fields */
  #form-container form p {
    margin-bottom: 0.5rem;
  }
  #form-container input[type="text"],
  #form-container input[type="hidden"] {
    width: 50%;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
  }

  /* Submit button */
  .btn-save {
    background: #1d4ed8;   /* blue */
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .btn-save:hover {
    background: #2563eb;   /* slightly lighter blue */
  }

  /* Search form at top */
  #city-search {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  #city-input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }

  /* Search button */
  .btn-search {
    background: #10b981;  /* green */
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  .btn-search:hover {
    background: #059669;
  }

  /* Map container */
  #map {
    height: 350px;
    border-radius: 6px;
    margin: 1rem 0;
    border: 1px solid #ddd;
  }

  /* Success message */
  .success-msg {
    padding: 0.5rem;
    margin-top: 0.5rem;
    background: #ecfdf5;
    color: #065f46;
    border: 1px solid #a7f3d0;
    border-radius: 4px;
    font-size: 14px;
  }
  </style>
</head>
<body>
  <h1>Select a location</h1>

  <form id="city-search" class="mb-4 flex gap-2" onsubmit="return false;">
    <input type="text" id="city-input" placeholder="Enter a city to start searching addresses ..."
          class="border rounded px-2 py-1 w-64">
    <button type="button" id="city-btn" class="bg-blue-500 text-white px-3 py-1 rounded">
      Re-center map
    </button>
  </form>


  <div id="form-container">
    <form
        id="address-form"
        method="post"
        action="{% url 'address_save' %}"
        hx-post="{% url 'address_save' %}"
        hx-target="#feedback"
        hx-swap="innerHTML"
        >
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn-save">Save</button>
    </form>
  </div>
  <div id="feedback"></div>

  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Optional: a simple geocoder control -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <script>
    const map = L.map('map').setView([40.4168, -3.7038], 12); // Madrid default
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Form inputs
    const addressInput = document.getElementById("id_address");
    const latInput = document.getElementById("id_lat");
    const lonInput = document.getElementById("id_lon");

    let marker;

    function setPoint(lat, lon) {
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lon]).addTo(map);

      // Reverse geocode with Nominatim (add your contact email per policy)
      const NOMINATIM_EMAIL = "{{ email|escapejs }}";

      const url = new URL("https://nominatim.openstreetmap.org/reverse");
      url.search = new URLSearchParams({
        format: "jsonv2",
        lat: lat,
        lon: lon,
        addressdetails: 1,
        zoom: 18,
        email: NOMINATIM_EMAIL,
      });

      fetch(url, { headers: { "Accept-Language": "en" }})
        .then(r => r.json())
        .then(data => {
          const display = data.display_name || `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          addressInput.value = display;
          latInput.value = lat;
          lonInput.value = lon;
        })
        .catch(() => {
          addressInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          latInput.value = lat;
          lonInput.value = lon;
        });
    }

    // Click on map â†’ set marker + fill form
    map.on("click", (e) => {
      const { lat, lng } = e.latlng;
      setPoint(lat, lng);
    });

    // Optional: add a search box (Leaflet Control Geocoder)
    if (L.Control.Geocoder) {
      const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false
      })
      .on("markgeocode", function(e) {
        const c = e.geocode.center;
        map.setView(c, 17);
        setPoint(c.lat, c.lng);
      })
      .addTo(map);
    }

    // re-align map
    const cityInput = document.getElementById("city-input");
    const cityBtn = document.getElementById("city-btn");

    cityBtn.addEventListener("click", () => {
      const city = cityInput.value.trim();
      if (!city) return;

      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.search = new URLSearchParams({
        q: city,
        format: "json",
        limit: 1
      });

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data.length > 0) {
            const { lat, lon } = data[0];
            map.setView([lat, lon], 12); // recenter map
            setPoint(lat, lon);          // reuse your marker + form filling
          } else {
            alert("City not found");
          }
        })
        .catch(err => console.error(err));
    });

    // hide feedback message after a delay
    document.body.addEventListener("htmx:afterSwap", function (e) {
      // only act on #feedback swaps
      if (e.target.id === "feedback") {
        setTimeout(() => {
          e.target.innerHTML = "";   // clear the feedback message
        }, 1500); // 1.5 seconds
      }
    });

  </script>

</body>
</html>
